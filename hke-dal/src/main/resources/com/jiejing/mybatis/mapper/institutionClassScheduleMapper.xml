<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jiejing.dao.InstitutionClassScheduleMapper">
    <resultMap id="BaseResultMap" type="com.jiejing.model.InstitutionClassSchedule">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="inst_id" property="instId" jdbcType="BIGINT"/>
        <result column="class_id" property="classId" jdbcType="BIGINT"/>
        <result column="class_status" property="classStatus" jdbcType="INTEGER"/>
        <result column="teacher_name" property="teacherName" jdbcType="VARCHAR"/>
        <result column="begin_date" property="beginDate" jdbcType="TIMESTAMP"/>
        <result column="end_date" property="endDate" jdbcType="TIMESTAMP"/>
        <result column="start_minute" property="startMinute" jdbcType="INTEGER"/>
        <result column="end_minute" property="endMinute" jdbcType="INTEGER"/>
        <result column="step" property="step" jdbcType="INTEGER"/>
        <result column="gmt_create" property="gmtCreate" jdbcType="TIMESTAMP"/>
        <result column="gmt_modify" property="gmtModify" jdbcType="TIMESTAMP"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
        <result column="trial_student_ids" property="trialStudentIds" jdbcType="VARCHAR"/>
        <result column="week" property="week" jdbcType="INTEGER"/>
        <result column="loop_time" property="loopTime" jdbcType="INTEGER"/>
        <result column="schedule_type" property="scheduleType" jdbcType="INTEGER"/>
        <result column="sign_id" property="signId" jdbcType="VARCHAR"/>
        <result column="batch_id" property="batchId" jdbcType="BIGINT"/>
        <result column="sign_date" property="signDate" jdbcType="TIMESTAMP"/>
        <result column="sign_status" property="signStatus" jdbcType="INTEGER"/>
        <result column="split_flag" property="splitFlag" jdbcType="INTEGER"/>
        <result column="temp_status" property="tempStatus" jdbcType="INTEGER"/>
        <result column="sign_schedule_id" property="signScheduleId" jdbcType="BIGINT"/>
        <result column="teacher_ids" property="teacherIds" jdbcType="VARCHAR"/>
        <result column="class_room_id" property="classRoomId" jdbcType="BIGINT"/>
        <result column="class_room_name" property="classRoomName" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="timeZoneHaveCommon">
        <![CDATA[
        (#{startMinute} - end_minute)*(#{endMinute} - start_minute) < 0
         ]]> ;
    </sql>

    <sql id="sameTime">
        week=#{week}
        AND
        <include refid="timeZoneHaveCommon"/>
    </sql>

    <!-- 隔周可能的时间判断 -->
    <sql id="skipWeklyCondition">
        (
            datediff(
            subdate(#{beginDate}, date_format(#{beginDate}, '%w')-1),
            subdate(begin_date, date_format(begin_date, '%w')-1)
        ) DIV 7
        ) MOD 2 = 0
    </sql>

    <sql id="topLevelSameTime">
        <include refid="skipWeklyCondition"/>
        AND
        <include refid="sameTime"/>
    </sql>

    <sql id="classConflict">
        SELECT *
        FROM institution_class_schedule
        WHERE class_id = #{classId}
    </sql>

    <sql id="roomConflict">
        SELECT *
        FROM institution_class_schedule
        WHERE class_room_id = #{classRoomId}
    </sql>

    <sql id="teacherConflict">
        SELECT *
        FROM institution_class_schedule
        WHERE find_in_set(teacher_ids, #{teacherId})
    </sql>

    <!--####################################  参数为每周    ####################################-->
    <!--#### 每周与 每周、隔周 ####-->
    <!-- 班内冲突 -->
    <sql id="weeklyCondition">
        schedule_type='2'
        AND
        <include refid="sameTime"/>
    </sql>
    <select id="selectWeeklyClassConflict" resultMap="BaseResultMap">
        <include refid="classConflict"/>
        AND
        <include refid="weeklyCondition"/>
    </select>

    <!-- 教室冲突 -->
    <select id="selectWeeklyRoomConflict" resultMap="BaseResultMap">
        <include refid="roomConflict"/>
        AND
        <include refid="weeklyCondition"/>
    </select>

    <!-- 老师冲突 -->
    <select id="selectWeeklyTeacherConflict" resultMap="BaseResultMap">
        <include refid="teacherConflict"/>
        AND
        <include refid="weeklyCondition"/>
    </select>

    <!-- 学生冲突 -->
    <select id="selectWeeklyStudentConflict" resultMap="BaseResultMap">
        SELECT * FROM (

        institution_class
        LEFT JOIN institution_student_class ON institution_class.class_id = institution_student_class.class_id
        LEFT JOIN institution_student ON institution_student_class.student_id = institution_student.student_id

        ) WHERE institution_student_class.class_id IN (

        SELECT class_id FROM institution_class_schedule WHERE
        <include refid="weeklyCondition"/>

        ) AND institution_student.student_id IN (
        <foreach collection="list" item="studentId" separator=",">
            studentId
        </foreach>
        )

    </select>

    <!--#### 每周与 课次 ####-->
    <sql id="WeeklyCompareKCCondition">
        schedule_type='1'
        AND
        begin_date >= curdate()
        AND
        <include refid="sameTime"/>
    </sql>
    <!-- 班内冲突 -->
    <select id="selectWeeklyCompareKCClassConflict" resultMap="BaseResultMap">
        <include refid="classConflict"/>
        AND
        <include refid="WeeklyCompareKCCondition"/>
    </select>

    <!-- 教室冲突 -->
    <select id="selectWeeklyCompareKCRoomConflict" resultMap="BaseResultMap">
        <include refid="roomConflict"/>
        AND
        <include refid="WeeklyCompareKCCondition"/>
    </select>

    <!-- 老师冲突 -->
    <select id="selectWeeklyCompareKCTeacherConflict" resultMap="BaseResultMap">
        <include refid="teacherConflict"/>
        AND
        <include refid="WeeklyCompareKCCondition"/>
    </select>

    <!-- 学生冲突 -->
    <select id="selectWeeklyCompareKCStudentConflict" resultMap="BaseResultMap">
        SELECT * FROM (

        institution_class
        LEFT JOIN institution_student_class ON institution_class.class_id = institution_student_class.class_id
        LEFT JOIN institution_student ON institution_student_class.student_id = institution_student.student_id

        ) WHERE institution_student_class.class_id IN (

        SELECT class_id FROM institution_class_schedule WHERE
        <include refid="WeeklyCompareKCCondition"/>

        ) AND institution_student.student_id IN (
        <foreach collection="list" item="studentId" separator=",">
            studentId
        </foreach>
        )

    </select>


    <!--####################################  参数为隔周    ####################################-->

    <!--#### 隔周 与 每周 ####-->
    <!-- 与每周与隔周相同-->

    <!--#### 隔周 与 隔周 ####-->
    <sql id="SkipCompareThisCondition">
        schedule_type='2'
        AND
        step=14
        AND
        <include refid="topLevelSameTime"/>
    </sql>

    <!-- 班内冲突 -->
    <select id="selectSkipWeeklyCompareThisClassConflict" resultMap="BaseResultMap">
        <include refid="classConflict"/>
        AND
        <include refid="SkipCompareThisCondition"/>
    </select>

    <!-- 教室冲突 -->
    <select id="selectSkipWeeklyCompareThisRoomConflict" resultMap="BaseResultMap">
        <include refid="roomConflict"/>
        AND
        <include refid="SkipCompareThisCondition"/>
    </select>

    <!-- 老师冲突 -->
    <select id="selectSkipWeeklyCompareThisTeacherConflict" resultMap="BaseResultMap">
        <include refid="teacherConflict"/>
        AND
        <include refid="SkipCompareThisCondition"/>
    </select>

    <!-- 学生冲突 -->
    <select id="selectSkipWeeklyCompareThisStudentConflict" resultMap="BaseResultMap">
        SELECT * FROM (

        institution_class
        LEFT JOIN institution_student_class ON institution_class.class_id = institution_student_class.class_id
        LEFT JOIN institution_student ON institution_student_class.student_id = institution_student.student_id

        ) WHERE institution_student_class.class_id IN (

        SELECT class_id FROM institution_class_schedule WHERE
        <include refid="SkipCompareThisCondition"/>

        ) AND institution_student.student_id IN (
        <foreach collection="list" item="studentId" separator=",">
            studentId
        </foreach>
        )

    </select>


    <!--#### 隔周 与 课次 ####-->
    <sql id="SkipWeeklyCompareKCCondition">
        schedule_type='1'
        AND
        <include refid="topLevelSameTime"/>
    </sql>
    <!-- 班内冲突 -->
    <select id="selectSkipWeeklyCompareKCClassConflict" resultMap="BaseResultMap">
        <include refid="classConflict"/>
        AND
        <include refid="SkipCompareKCCondition"/>
    </select>

    <!-- 教室冲突 -->
    <select id="selectSkipWeeklyCompareKCRoomConflict" resultMap="BaseResultMap">
        <include refid="roomConflict"/>
        AND
        <include refid="SkipCompareKCCondition"/>
    </select>

    <!-- 老师冲突 -->
    <select id="selectSkipWeeklyTeacherConflict" resultMap="BaseResultMap">
        <include refid="teacherConflict"/>
        AND
        <include refid="SkipCompareKCCondition"/>
    </select>

    <!-- 学生冲突 -->
    <select id="selectSkipWeeklyStudentConflict" resultMap="BaseResultMap">
        SELECT * FROM (

        institution_class
        LEFT JOIN institution_student_class ON institution_class.class_id = institution_student_class.class_id
        LEFT JOIN institution_student ON institution_student_class.student_id = institution_student.student_id

        ) WHERE institution_student_class.class_id IN (

        SELECT class_id FROM institution_class_schedule WHERE
        <include refid="SkipCompareKCCondition"/>

        ) AND institution_student.student_id IN (
        <foreach collection="list" item="studentId" separator=",">
            studentId
        </foreach>
        )

    </select>


    <!--#####################################  参数为课次   ####################################-->
    <!--#### 课次 与 课次 ####-->
    <sql id="KCCompareKCCondition">
        schedule_type='1'
        AND
        <include refid="timeZoneHaveCommon"/>
        AND
        begin_date=#{beginDate}
        AND
    </sql>
    <!-- 班内冲突 -->
    <select id="selectKCCompareKCConflict" resultMap="BaseResultMap">
        <include refid="classConflict"/>
        AND
        <include refid="KCCompareKCCondition"/>
    </select>

    <!-- 教室冲突 -->
    <select id="selectKCCompareKCRoomConflict" resultMap="BaseResultMap">
        <include refid="roomConflict"/>
        AND
        <include refid="KCCompareKCCondition"/>
    </select>

    <!-- 老师冲突 -->
    <select id="selectKCCompareKCTeacherConflict" resultMap="BaseResultMap">
        <include refid="teacherConflict"/>
        AND
        <include refid="KCCompareKCCondition"/>
    </select>

    <!-- 学生冲突 -->
    <select id="selectKCCompareKCStudentConflict" resultMap="BaseResultMap">
        SELECT * FROM (

        institution_class
        LEFT JOIN institution_student_class ON institution_class.class_id = institution_student_class.class_id
        LEFT JOIN institution_student ON institution_student_class.student_id = institution_student.student_id

        ) WHERE institution_student_class.class_id IN (

        SELECT class_id FROM institution_class_schedule WHERE
        <include refid="KCCompareKCCondition"/>

        ) AND institution_student.student_id IN (
        <foreach collection="list" item="studentId" separator=",">
            studentId
        </foreach>
        )

    </select>

    <!--#### 课次 与 每周 ####-->
    <sql id="KCCompareWeeklyCondition">
        schedule_type='2'
        AND
        step=7
        AND
        <include refid="sameTime"/>
    </sql>

    <!-- 班内冲突 -->
    <select id="selectKCCompareWeeklyClassConflict" resultMap="BaseResultMap">
        <include refid="classConflict"/>
        AND
        <include refid="KCCompareWeeklyCondition"/>
    </select>

    <!-- 教室冲突 -->
    <select id="selectKCCompareWeeklyRoomConflict" resultMap="BaseResultMap">
        <include refid="roomConflict"/>
        AND
        <include refid="KCCompareWeeklyCondition"/>
    </select>

    <!-- 老师冲突 -->
    <select id="selectKCCompareWeeklyTeacherConflict" resultMap="BaseResultMap">
        <include refid="teacherConflict"/>
        AND
        <include refid="KCCompareWeeklyCondition"/>
    </select>

    <!-- 学生冲突 -->
    <select id="selectKCCompareWeeklyStudentConflict" resultMap="BaseResultMap">
        SELECT * FROM (

        institution_class
        LEFT JOIN institution_student_class ON institution_class.class_id = institution_student_class.class_id
        LEFT JOIN institution_student ON institution_student_class.student_id = institution_student.student_id

        ) WHERE institution_student_class.class_id IN (

        SELECT class_id FROM institution_class_schedule WHERE
        <include refid="KCCompareWeeklyCondition"/>

        ) AND institution_student.student_id IN (
        <foreach collection="list" item="studentId" separator=",">
            studentId
        </foreach>
        )

    </select>


    <!--#### 课次 与 隔周 ####-->
    <sql id="KCCompareSkipWeeklyCondition">
        schedule_type='2'
        AND
        step=14
        AND
        <include refid="topLevelSameTime"/>
    </sql>

    <!-- 班内冲突 -->
    <select id="selectKCCompareSkipWeeklyClassConflict" resultMap="BaseResultMap">
        <include refid="classConflict"/>
        AND
        <include refid="KCCompareSkipWeeklyCondition"/>
    </select>

    <!-- 教室冲突 -->
    <select id="selectKCCompareSkipWeeklyRoomConflict" resultMap="BaseResultMap">
        <include refid="roomConflict"/>
        AND
        <include refid="KCCompareSkipWeeklyCondition"/>
    </select>

    <!-- 老师冲突 -->
    <select id="selectKCCompareSkipWeeklyTeacherConflict" resultMap="BaseResultMap">
        <include refid="teacherConflict"/>
        AND
        <include refid="KCCompareSkipWeeklyCondition"/>
    </select>

    <!-- 学生冲突 -->
    <select id="selectKCCompareSkipWeeklyStudentConflict" resultMap="BaseResultMap">
        SELECT * FROM (

        institution_class
        LEFT JOIN institution_student_class ON institution_class.class_id = institution_student_class.class_id
        LEFT JOIN institution_student ON institution_student_class.student_id = institution_student.student_id

        ) WHERE institution_student_class.class_id IN (

        SELECT class_id FROM institution_class_schedule WHERE
        <include refid="KCCompareSkipWeeklyCondition"/>

        ) AND institution_student.student_id IN (
        <foreach collection="list" item="studentId" separator=",">
            studentId
        </foreach>
        )

    </select>

</mapper>